import logger from '../config/logger';
import { validateEnv } from '../config/env';
import { SMTPProvider } from './providers/SMTPProvider';
import { SendGridProvider } from './providers/SendGridProvider';
import { SESProvider } from './providers/SESProvider';
import { ConsoleProvider } from './providers/ConsoleProvider';
import EmailLog from '../models/EmailLog';
import { TemplateService } from './TemplateService';
import { EmailOptions, EmailResult } from '../types';

// Admin invite email data interface
interface AdminInviteData {
  email: string;
  role: string;
  inviteLink: string;
  expiresAt: Date;
  name?: string;
  firstName?: string;
  lastName?: string;
  phone?: string;
  department?: string;
  employeeId?: string;
  salary?: string | number;
  joiningDate?: string;
  reportingManager?: string;
}

export class EmailService {
  private static provider: any;
  private static env = validateEnv();

  private static getProvider() {
    if (!this.provider) {
      switch (this.env.EMAIL_PROVIDER) {
        case 'sendgrid':
          this.provider = new SendGridProvider();
          break;
        case 'ses':
          this.provider = new SESProvider();
          break;
        case 'smtp':
          this.provider = new SMTPProvider();
          break;
        case 'console':
          this.provider = new ConsoleProvider();
          break;
        default:
          throw new Error(`Unknown email provider: ${this.env.EMAIL_PROVIDER}`);
      }
    }
    return this.provider;
  }

  static async sendEmail(options: EmailOptions): Promise<EmailResult> {
    console.log('[EmailService] sendEmail called', {
      to: options.to,
      subject: options.subject,
      provider: this.env.EMAIL_PROVIDER
    });

    try {
      let html = options.html;
      let text = options.text;

      // Render template if provided
      if (options.template) {
        const rendered = TemplateService.render(options.template, options.data || {});
        html = rendered.html;
        text = rendered.text;
      }

      // Validate
      if (!html && !text) {
        throw new Error('Either html, text, or template must be provided');
      }

      // Get provider
      const provider = this.getProvider();

      // Send email
      const result = await provider.send({
        to: options.to,
        from: {
          email: this.env.EMAIL_FROM_ADDRESS,
          name: this.env.EMAIL_FROM_NAME,
        },
        replyTo: this.env.EMAIL_REPLY_TO,
        subject: options.subject,
        html: html || '',
        text: text || TemplateService.stripHtml(html || ''),
        cc: options.cc,
        bcc: options.bcc,
        attachments: options.attachments,
      });

      // Log email (non-blocking)
      this.logEmail({
        to: Array.isArray(options.to) ? options.to : [options.to],
        subject: options.subject,
        template: options.template,
        status: 'sent',
        messageId: result.messageId,
        provider: this.env.EMAIL_PROVIDER,
        metadata: options.metadata,
      });

      logger.info('Email sent successfully', {
        to: options.to,
        subject: options.subject,
        template: options.template,
        messageId: result.messageId,
      });
      console.log('[EmailService] Email sent successfully!', result.messageId);

      return {
        success: true,
        messageId: result.messageId,
      };
    } catch (error: any) {
      console.error('[EmailService] Email send failed:', error);
      logger.error('Email send failed', {
        to: options.to,
        subject: options.subject,
        template: options.template,
        error: error.message,
      });

      // Log failed email (non-blocking)
      this.logEmail({
        to: Array.isArray(options.to) ? options.to : [options.to],
        subject: options.subject,
        template: options.template,
        status: 'failed',
        error: error.message,
        provider: this.env.EMAIL_PROVIDER,
        metadata: options.metadata,
      });

      return {
        success: false,
        error: error.message,
      };
    }
  }

  private static logEmail(data: any) {
    // Don't await - log asynchronously to avoid blocking email sending
    EmailLog.create({
      ...data,
      sentAt: new Date(),
    }).catch((error: any) => {
      logger.error('Failed to log email', { error: error.message });
    });
  }

  // Convenience methods

  /**
   * Send admin invite email (employee registration)
   */
  static async sendAdminInviteEmail(data: AdminInviteData) {
    console.log('[EmailService] sendAdminInviteEmail called', { email: data.email, role: data.role });

    return this.sendEmail({
      to: data.email,
      subject: "Welcome! Complete Your A10 Admin Registration",
      template: 'admin_invite',
      data: {
        role: data.role,
        name: data.name,
        firstName: data.firstName,
        lastName: data.lastName,
        phone: data.phone,
        department: data.department,
        employeeId: data.employeeId,
        salary: data.salary,
        joiningDate: data.joiningDate,
        reportingManager: data.reportingManager,
        inviteLink: data.inviteLink,
        expiresAt: data.expiresAt,
      },
      metadata: { type: 'admin_invite' },
    });
  }

  static async sendAccountCreatedEmail(email: string, name: string, phone?: string) {
    return this.sendEmail({
      to: email,
      subject: 'Your A10 Admin Account is Ready!',
      template: 'account_created',
      data: {
        name,
        phone,
        loginUrl: `${this.env.WEB_APP_URL}/login`,
        supportEmail: 'support@a10.com',
      },
      metadata: { type: 'account_created' },
    });
  }

  /**
   * Send password reset email
   */
  static async sendPasswordResetEmail(
    email: string,
    resetLink: string,
    name?: string,
    expiresAt?: Date
  ) {
    const formattedExpiresAt = expiresAt
      ? expiresAt.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
      })
      : undefined;

    return this.sendEmail({
      to: email,
      subject: 'Reset Your A10 Admin Password',
      template: 'password_reset',
      data: {
        name: name || email.split('@')[0],
        resetLink,
        expiresAt: formattedExpiresAt,
      },
      metadata: { type: 'password_reset' },
    });
  }
}
